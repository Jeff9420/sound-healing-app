<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声音疗愈空间 - 专业音频疗法平台 | Sound Healing Space</title>

    <!-- Website Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY2NkZGO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRjY2OTk7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPGVSBGF0aCBkPSJNMTYgNEMxOC43NjE0IDQgMjEgNi4yMzg2IDIxIDlWMjNDMjEgMjUuNzYxNCAxOC43NjE0IDI4IDE2IDI4QzEzLjIzODYgMjggMTEgMjUuNzYxNCAxMSAyM1Y5QzExIDYuMjM4NiAxMy4yMzg2IDQgMTYgNFoiIGZpbGw9InVybCgjZ3JhZGllbnQpIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjMiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjIiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjciLz4KPGNpcmNsZSBjeD0iMjIiIGN5PSIyMiIgcj0iMiIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuNyIvPgo8L3N2Zz4K">

    <!-- SEO Meta Tags -->
    <meta name="description" content="声音疗愈空间 - 专业音频疗法平台，提供221+种疗愈音频，包括自然声音、冥想音乐、颂钵疗愈等。帮助您放松身心，改善睡眠，减轻压力。">
    <meta name="keywords" content="声音疗愈,音频疗法,冥想音乐,助眠音乐,放松音乐,自然声音,颂钵疗愈,减压音乐,专注音乐,身心健康">
    <meta name="author" content="Sound Healing Space">

    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://archive.org https://www.googletagmanager.com https://www.google-analytics.com https://www.clarity.ms; style-src 'self' 'unsafe-inline' https://archive.org; media-src 'self' https: data:; connect-src 'self' https://archive.org; img-src 'self' data: https:;">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/mobile-optimization.css">
    <link rel="stylesheet" href="assets/css/touch-target-optimization.css">
    <link rel="stylesheet" href="assets/css/color-contrast-enhancement.css">

    <!-- Critical CSS Inlined -->
    <style>
        /* Critical CSS for loading */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #6666FF 0%, #FF6699 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6666FF 0%, #FF6699 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2em;
            text-align: center;
        }

        /* Main app container */
        #app {
            display: none;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .debug-panel button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            🎵 正在加载声音疗愈空间...<br>
            <small style="opacity: 0.8;">请稍候，正在加载221个疗愈音频</small>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-section">
                    <h1 class="app-title">🎵 声音疗愈空间</h1>
                    <p class="app-subtitle">专业音频疗法平台 - 221+种疗愈音频</p>
                </div>

                <!-- Control Buttons -->
                <div class="header-controls">
                    <button id="themeToggle" class="control-btn" title="切换主题">🌙</button>
                    <button id="sleepTimerBtn" class="control-btn" title="睡眠定时器">⏰</button>
                    <button id="debugToggle" class="control-btn" title="调试面板">🔧</button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Category Selection -->
            <section id="categorySection" class="category-section">
                <h2 class="section-title">选择疗愈类别</h2>
                <div id="categoryGrid" class="category-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </section>

            <!-- Playlist Section -->
            <section id="playlistSection" class="playlist-section" style="display: none;">
                <div class="playlist-header">
                    <button id="backToCategories" class="back-btn">← 返回类别</button>
                    <h2 id="playlistTitle" class="playlist-title"></h2>
                    <div class="playlist-controls">
                        <button id="shuffleBtn" class="control-btn" title="随机播放">🔀</button>
                        <button id="repeatBtn" class="control-btn" title="循环播放">🔁</button>
                    </div>
                </div>
                <div id="playlistContainer" class="playlist-container">
                    <div id="trackList" class="track-list">
                        <!-- Tracks will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Now Playing Section -->
            <section id="nowPlayingSection" class="now-playing-section">
                <div class="now-playing-content">
                    <div class="track-info">
                        <div class="track-name" id="currentTrackName">未播放</div>
                        <div class="track-artist" id="currentTrackArtist">请选择音频</div>
                        <div class="track-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>

                    <div class="player-controls">
                        <button id="prevBtn" class="control-btn" title="上一曲">⏮️</button>
                        <button id="playPauseBtn" class="control-btn primary-btn" title="播放/暂停">▶️</button>
                        <button id="nextBtn" class="control-btn" title="下一曲">⏭️</button>
                        <button id="stopBtn" class="control-btn" title="停止">⏹️</button>
                    </div>

                    <div class="volume-control">
                        <span class="volume-icon">🔊</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="70">
                        <span id="volumeValue" class="volume-value">70%</span>
                    </div>
                </div>

                <audio id="audioPlayer" preload="metadata"></audio>
            </section>
        </main>

        <!-- Background Canvas -->
        <canvas id="backgroundCanvas" class="background-canvas"></canvas>

        <!-- Sleep Timer Modal -->
        <div id="sleepTimerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>睡眠定时器</h3>
                    <button class="close-btn" onclick="closeSleepTimer()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="timer-options">
                        <button onclick="setSleepTimer(5)">5分钟</button>
                        <button onclick="setSleepTimer(10)">10分钟</button>
                        <button onclick="setSleepTimer(15)">15分钟</button>
                        <button onclick="setSleepTimer(30)">30分钟</button>
                        <button onclick="setSleepTimer(60)">60分钟</button>
                        <button onclick="setSleepTimer(0)">关闭</button>
                    </div>
                    <div class="custom-timer">
                        <input type="number" id="customTimerMinutes" placeholder="自定义分钟" min="1" max="480">
                        <button onclick="setCustomSleepTimer()">设置</button>
                    </div>
                    <div id="timerStatus" class="timer-status"></div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel" style="display: none;">
            <div class="debug-header">
                <strong>调试面板</strong>
                <button onclick="toggleDebugPanel()">✖</button>
            </div>
            <div id="debugContent"></div>
            <div class="debug-controls">
                <button onclick="runDiagnostics()">运行诊断</button>
                <button onclick="showAppStatus()">应用状态</button>
                <button onclick="testAudioPlayback()">测试音频</button>
                <button onclick="clearDebugLog()">清除日志</button>
            </div>
        </div>
    </div>

    <!-- Security Modules (must load first) -->
    <script src="assets/js/security-utils.js"></script>
    <script src="assets/js/csrf-protection.js"></script>

    <!-- Core Application -->
    <script src="assets/js/audio-config.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- UI Components -->
    <script src="assets/js/ui-controller.js"></script>
    <script src="assets/js/playlist-ui.js"></script>
    <script src="assets/js/audio-manager.js"></script>

    <!-- Background Scenes -->
    <script src="assets/js/background-scene-manager.js"></script>

    <!-- Additional Features -->
    <script src="assets/js/sleep-timer.js"></script>
    <script src="assets/js/theme-manager.js"></script>
    <script src="assets/js/performance-monitor.js"></script>
    <script src="assets/js/visual-effects.js"></script>

    <!-- Security & Accessibility Features -->
    <script src="assets/js/aria-optimizer.js" defer></script>
    <script src="assets/js/sri-manager.js" defer></script>
    <script src="assets/js/gdpr-manager.js" defer></script>

    <script>
        // Global variables
        let app = null;
        let currentCategory = null;
        let isPlaying = false;
        let currentTrackIndex = 0;
        let isShuffleOn = false;
        let isRepeatOn = false;
        let sleepTimerInterval = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🎵 声音疗愈空间开始初始化...');

            try {
                // Hide loading screen after initialization
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    console.log('✅ 加载界面已显示');
                }, 2000);

                // Initialize app
                if (typeof SoundHealingApp !== 'undefined') {
                    app = new SoundHealingApp();
                    await app.initialize();
                    console.log('✅ 主应用初始化完成');
                }

                // Load categories
                loadCategories();

                // Setup event listeners
                setupEventListeners();

                // Initialize background animation
                initBackgroundAnimation();

                // Show welcome message
                showStatus('🎵 声音疗愈空间加载完成！选择一个类别开始疗愈之旅');

            } catch (error) {
                console.error('❌ 初始化失败:', error);
                showStatus('❌ 初始化失败: ' + error.message, 'error');
            }
        });

        function loadCategories() {
            console.log('📂 开始加载音频类别...');
            const categoryGrid = document.getElementById('categoryGrid');

            if (!window.AUDIO_CONFIG) {
                console.error('❌ AUDIO_CONFIG 未找到');
                showStatus('❌ 音频配置加载失败', 'error');
                return;
            }

            const categories = Object.keys(window.AUDIO_CONFIG.categories);
            console.log(`📂 找到 ${categories.length} 个音频类别`);

            if (categories.length === 0) {
                showStatus('❌ 没有找到音频类别', 'error');
                return;
            }

            categoryGrid.innerHTML = '';

            categories.forEach(categoryKey => {
                const category = window.AUDIO_CONFIG.categories[categoryKey];
                const categoryEl = createCategoryElement(categoryKey, category);
                categoryGrid.appendChild(categoryEl);
            });

            console.log(`✅ 成功加载 ${categories.length} 个类别`);
            showStatus(`🎵 已加载 ${categories.length} 个疗愈类别，共 ${countTotalFiles()} 个音频文件`);
        }

        function createCategoryElement(categoryKey, category) {
            const div = document.createElement('div');
            div.className = 'category-card';
            div.dataset.category = categoryKey;
            div.onclick = () => openCategory(categoryKey);

            const fileCount = category.files ? category.files.length : 0;

            div.innerHTML = `
                <div class="category-icon">${category.icon || '🎵'}</div>
                <div class="category-name">${category.name || categoryKey}</div>
                <div class="category-desc">${category.description || '疗愈音乐'}</div>
                <div class="category-count">${fileCount} 个音频</div>
            `;

            return div;
        }

        function countTotalFiles() {
            if (!window.AUDIO_CONFIG) return 0;

            return Object.values(window.AUDIO_CONFIG.categories)
                .reduce((total, category) => total + (category.files ? category.files.length : 0), 0);
        }

        function openCategory(categoryKey) {
            console.log(`🎵 打开类别: ${categoryKey}`);
            currentCategory = categoryKey;

            const categorySection = document.getElementById('categorySection');
            const playlistSection = document.getElementById('playlistSection');
            const playlistTitle = document.getElementById('playlistTitle');
            const trackList = document.getElementById('trackList');

            if (!window.AUDIO_CONFIG.categories[categoryKey]) {
                showStatus('❌ 类别不存在', 'error');
                return;
            }

            const category = window.AUDIO_CONFIG.categories[categoryKey];
            playlistTitle.textContent = `${category.icon} ${category.name}`;

            // Load tracks
            trackList.innerHTML = '';
            category.files.forEach((fileName, index) => {
                const trackEl = createTrackElement(fileName, index, categoryKey);
                trackList.appendChild(trackEl);
            });

            // Show playlist, hide categories
            categorySection.style.display = 'none';
            playlistSection.style.display = 'block';

            showStatus(`🎵 已加载 ${category.files.length} 个${category.name}音频`);
        }

        function createTrackElement(fileName, index, categoryKey) {
            const div = document.createElement('div');
            div.className = 'track-item';
            div.dataset.trackIndex = index;
            div.dataset.category = categoryKey;
            div.onclick = () => playTrack(index, categoryKey, fileName);

            // Clean up file name for display
            const displayName = fileName.replace('.mp3', '').replace(/\d{1,2}-/, '');

            div.innerHTML = `
                <div class="track-number">${index + 1}</div>
                <div class="track-info">
                    <div class="track-title">${displayName}</div>
                    <div class="track-duration">--:--</div>
                </div>
            `;

            return div;
        }

        function playTrack(index, categoryKey, fileName) {
            console.log(`🎵 播放: ${fileName}`);

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTrackName = document.getElementById('currentTrackName');
            const currentTrackArtist = document.getElementById('currentTrackArtist');

            // Update UI
            currentTrackName.textContent = fileName.replace('.mp3', '');
            currentTrackArtist.textContent = window.AUDIO_CONFIG.categories[categoryKey].name;

            // Get audio URL
            const audioUrl = getAudioUrl(categoryKey, fileName);
            if (!audioUrl) {
                showStatus('❌ 音频URL生成失败', 'error');
                return;
            }

            // Play audio
            audioPlayer.src = audioUrl;
            audioPlayer.play().then(() => {
                isPlaying = true;
                updatePlayPauseButton();
                currentTrackIndex = index;
                showStatus(`🎵 正在播放: ${fileName.replace('.mp3', '')}`);
            }).catch(error => {
                console.error('播放失败:', error);
                showStatus('❌ 播放失败，请点击播放按钮', 'error');
            });
        }

        function getAudioUrl(categoryKey, fileName) {
            if (!window.AUDIO_CONFIG) return null;

            const category = window.AUDIO_CONFIG.categories[categoryKey];
            if (!category) return null;

            const folderName = category.folder || categoryKey.toLowerCase().replace(/\s+/g, '-');
            return `${window.AUDIO_CONFIG.baseUrl}${folderName}/${encodeURIComponent(fileName)}`;
        }

        function setupEventListeners() {
            // Play/Pause button
            document.getElementById('playPauseBtn').onclick = togglePlayPause;

            // Stop button
            document.getElementById('stopBtn').onclick = stopAudio;

            // Volume control
            const volumeSlider = document.getElementById('volumeSlider');
            volumeSlider.oninput = updateVolume;

            // Progress bar
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.ontimeupdate = updateProgress;
            audioPlayer.onloadedmetadata = updateDuration;
            audioPlayer.onended = handleTrackEnd;

            // Navigation buttons
            document.getElementById('backToCategories').onclick = backToCategories;
            document.getElementById('prevBtn').onclick = playPrevious;
            document.getElementById('nextBtn').onclick = playNext;

            // Control buttons
            document.getElementById('shuffleBtn').onclick = toggleShuffle;
            document.getElementById('repeatBtn').onclick = toggleRepeat;
            document.getElementById('themeToggle').onclick = toggleTheme;
            document.getElementById('sleepTimerBtn').onclick = openSleepTimer;
            document.getElementById('debugToggle').onclick = toggleDebugPanel;

            // Audio player events
            audioPlayer.onplay = () => { isPlaying = true; updatePlayPauseButton(); };
            audioPlayer.onpause = () => { isPlaying = false; updatePlayPauseButton(); };
        }

        function togglePlayPause() {
            const audioPlayer = document.getElementById('audioPlayer');

            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(error => {
                    console.error('播放失败:', error);
                    showStatus('❌ 播放失败', 'error');
                });
            }
        }

        function stopAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            updatePlayPauseButton();
            showStatus('⏹️ 已停止播放');
        }

        function updateVolume() {
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            const audioPlayer = document.getElementById('audioPlayer');

            const volume = volumeSlider.value;
            audioPlayer.volume = volume / 100;
            volumeValue.textContent = volume + '%';
        }

        function updateProgress() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progressFill = document.getElementById('progressFill');
            const currentTime = document.getElementById('currentTime');

            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = progress + '%';
                currentTime.textContent = formatTime(audioPlayer.currentTime);
            }
        }

        function updateDuration() {
            const audioPlayer = document.getElementById('audioPlayer');
            const totalTime = document.getElementById('totalTime');

            if (audioPlayer.duration) {
                totalTime.textContent = formatTime(audioPlayer.duration);
            }
        }

        function handleTrackEnd() {
            isPlaying = false;
            updatePlayPauseButton();

            if (isRepeatOn) {
                playCurrentTrack();
            } else {
                playNext();
            }
        }

        function playNext() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            if (isShuffleOn) {
                currentTrackIndex = Math.floor(Math.random() * category.files.length);
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % category.files.length;
            }

            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function playPrevious() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            currentTrackIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : category.files.length - 1;
            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function playCurrentTrack() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function toggleShuffle() {
            isShuffleOn = !isShuffleOn;
            const shuffleBtn = document.getElementById('shuffleBtn');
            shuffleBtn.style.opacity = isShuffleOn ? '1' : '0.5';
            showStatus(isShuffleOn ? '🔀 随机播放已开启' : '🔀 随机播放已关闭');
        }

        function toggleRepeat() {
            isRepeatOn = !isRepeatOn;
            const repeatBtn = document.getElementById('repeatBtn');
            repeatBtn.style.opacity = isRepeatOn ? '1' : '0.5';
            showStatus(isRepeatOn ? '🔁 循环播放已开启' : '🔁 循环播放已关闭');
        }

        function backToCategories() {
            const categorySection = document.getElementById('categorySection');
            const playlistSection = document.getElementById('playlistSection');

            categorySection.style.display = 'block';
            playlistSection.style.display = 'none';

            showStatus('📂 返回类别选择');
        }

        function updatePlayPauseButton() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.textContent = isPlaying ? '⏸️' : '▶️';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showStatus(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);

            // Create status notification
            const status = document.createElement('div');
            status.className = `status-notification ${type}`;
            status.textContent = message;
            status.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#4444ff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(status);

            setTimeout(() => {
                status.remove();
            }, 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            showStatus(isDark ? '🌙 已切换到深色主题' : '☀️ 已切换到浅色主题');
        }

        function openSleepTimer() {
            document.getElementById('sleepTimerModal').style.display = 'block';
        }

        function closeSleepTimer() {
            document.getElementById('sleepTimerModal').style.display = 'none';
        }

        function setSleepTimer(minutes) {
            if (sleepTimerInterval) {
                clearInterval(sleepTimerInterval);
            }

            if (minutes === 0) {
                showStatus('⏰ 睡眠定时器已关闭');
                document.getElementById('timerStatus').textContent = '';
                return;
            }

            const endTime = new Date(Date.now() + minutes * 60000);
            document.getElementById('timerStatus').textContent =
                `定时器已设置: ${minutes}分钟后停止 (${endTime.toLocaleTimeString()})`;

            sleepTimerInterval = setInterval(() => {
                const now = new Date();
                if (now >= endTime) {
                    stopAudio();
                    clearInterval(sleepTimerInterval);
                    showStatus('⏰ 睡眠定时器时间到，已停止播放');
                    document.getElementById('timerStatus').textContent = '';
                }
            }, 1000);

            showStatus(`⏰ 睡眠定时器已设置为${minutes}分钟`);
            closeSleepTimer();
        }

        function setCustomSleepTimer() {
            const minutes = parseInt(document.getElementById('customTimerMinutes').value);
            if (minutes > 0 && minutes <= 480) {
                setSleepTimer(minutes);
            } else {
                showStatus('❌ 请输入1-480之间的分钟数', 'error');
            }
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <div><strong>应用状态:</strong></div>
                <div>• 应用初始化: ${app ? '✅' : '❌'}</div>
                <div>• 当前类别: ${currentCategory || '无'}</div>
                <div>• 播放状态: ${isPlaying ? '▶️ 播放中' : '⏸️ 已暂停'}</div>
                <div>• 随机播放: ${isShuffleOn ? '✅' : '❌'}</div>
                <div>• 循环播放: ${isRepeatOn ? '✅' : '❌'}</div>
                <div>• 音频配置: ${window.AUDIO_CONFIG ? '✅' : '❌'}</div>
                <div>• 总文件数: ${countTotalFiles()}</div>
            `;
        }

        function runDiagnostics() {
            console.log('🔧 运行诊断...');
            let results = [];

            // 检查音频配置
            if (window.AUDIO_CONFIG) {
                const categoryCount = Object.keys(window.AUDIO_CONFIG.categories).length;
                const fileCount = countTotalFiles();
                results.push(`✅ 音频配置: ${categoryCount}个类别, ${fileCount}个文件`);
            } else {
                results.push('❌ 音频配置未加载');
            }

            // 检查音频元素
            const audioPlayer = document.getElementById('audioPlayer');
            results.push(`🎵 音频播放器: ${audioPlayer ? '✅' : '❌'}`);

            // 检查UI元素
            const elements = ['categoryGrid', 'trackList', 'playPauseBtn', 'volumeSlider'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                results.push(`🔲 ${id}: ${element ? '✅' : '❌'}`);
            });

            console.log('诊断结果:', results);
            showStatus('🔧 诊断完成，查看控制台了解详情');

            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '<div><strong>诊断结果:</strong></div>' +
                results.map(r => `<div>${r}</div>`).join('');
        }

        function showAppStatus() {
            updateDebugInfo();
            showStatus('📊 应用状态已更新到调试面板');
        }

        function testAudioPlayback() {
            if (!currentCategory) {
                showStatus('❌ 请先选择一个类别', 'error');
                return;
            }

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (category && category.files.length > 0) {
                playTrack(0, currentCategory, category.files[0]);
                showStatus('🧪 正在测试第一个音频文件');
            }
        }

        function clearDebugLog() {
            document.getElementById('debugContent').innerHTML = '';
            showStatus('🧹 调试日志已清除');
        }

        function initBackgroundAnimation() {
            const canvas = document.getElementById('backgroundCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Simple particle animation
            const particles = [];
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 3 + 1,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles.forEach(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;

                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${particle.opacity})`;
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }

            animate();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const sleepTimerModal = document.getElementById('sleepTimerModal');
            if (event.target === sleepTimerModal) {
                closeSleepTimer();
            }
        }

        // Add slide-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>