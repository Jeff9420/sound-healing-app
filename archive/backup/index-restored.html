<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°éŸ³ç–—æ„ˆç©ºé—´ - ä¸“ä¸šéŸ³é¢‘ç–—æ³•å¹³å° | Sound Healing Space</title>

    <!-- Website Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgo8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY2NkZGO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRjY2OTk7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPGVSBGF0aCBkPSJNMTYgNEMxOC43NjE0IDQgMjEgNi4yMzg2IDIxIDlWMjNDMjEgMjUuNzYxNCAxOC43NjE0IDI4IDE2IDI4QzEzLjIzODYgMjggMTEgMjUuNzYxNCAxMSAyM1Y5QzExIDYuMjM4NiAxMy4yMzg2IDQgMTYgNFoiIGZpbGw9InVybCgjZ3JhZGllbnQpIi8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjMiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjEwIiBjeT0iMTAiIHI9IjIiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjciLz4KPGNpcmNsZSBjeD0iMjIiIGN5PSIyMiIgcj0iMiIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuNyIvPgo8L3N2Zz4K">

    <!-- SEO Meta Tags -->
    <meta name="description" content="å£°éŸ³ç–—æ„ˆç©ºé—´ - ä¸“ä¸šéŸ³é¢‘ç–—æ³•å¹³å°ï¼Œæä¾›221+ç§ç–—æ„ˆéŸ³é¢‘ï¼ŒåŒ…æ‹¬è‡ªç„¶å£°éŸ³ã€å†¥æƒ³éŸ³ä¹ã€é¢‚é’µç–—æ„ˆç­‰ã€‚å¸®åŠ©æ‚¨æ”¾æ¾èº«å¿ƒï¼Œæ”¹å–„ç¡çœ ï¼Œå‡è½»å‹åŠ›ã€‚">
    <meta name="keywords" content="å£°éŸ³ç–—æ„ˆ,éŸ³é¢‘ç–—æ³•,å†¥æƒ³éŸ³ä¹,åŠ©çœ éŸ³ä¹,æ”¾æ¾éŸ³ä¹,è‡ªç„¶å£°éŸ³,é¢‚é’µç–—æ„ˆ,å‡å‹éŸ³ä¹,ä¸“æ³¨éŸ³ä¹,èº«å¿ƒå¥åº·">
    <meta name="author" content="Sound Healing Space">

    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://archive.org https://www.googletagmanager.com https://www.google-analytics.com https://www.clarity.ms; style-src 'self' 'unsafe-inline' https://archive.org; media-src 'self' https: data:; connect-src 'self' https://archive.org; img-src 'self' data: https:;">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/mobile-optimization.css">
    <link rel="stylesheet" href="assets/css/touch-target-optimization.css">
    <link rel="stylesheet" href="assets/css/color-contrast-enhancement.css">

    <!-- Critical CSS Inlined -->
    <style>
        /* Critical CSS for loading */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #6666FF 0%, #FF6699 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6666FF 0%, #FF6699 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2em;
            text-align: center;
        }

        /* Main app container */
        #app {
            display: none;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .debug-panel button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            ğŸµ æ­£åœ¨åŠ è½½å£°éŸ³ç–—æ„ˆç©ºé—´...<br>
            <small style="opacity: 0.8;">è¯·ç¨å€™ï¼Œæ­£åœ¨åŠ è½½221ä¸ªç–—æ„ˆéŸ³é¢‘</small>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-section">
                    <h1 class="app-title">ğŸµ å£°éŸ³ç–—æ„ˆç©ºé—´</h1>
                    <p class="app-subtitle">ä¸“ä¸šéŸ³é¢‘ç–—æ³•å¹³å° - 221+ç§ç–—æ„ˆéŸ³é¢‘</p>
                </div>

                <!-- Control Buttons -->
                <div class="header-controls">
                    <button id="themeToggle" class="control-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                    <button id="sleepTimerBtn" class="control-btn" title="ç¡çœ å®šæ—¶å™¨">â°</button>
                    <button id="debugToggle" class="control-btn" title="è°ƒè¯•é¢æ¿">ğŸ”§</button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Category Selection -->
            <section id="categorySection" class="category-section">
                <h2 class="section-title">é€‰æ‹©ç–—æ„ˆç±»åˆ«</h2>
                <div id="categoryGrid" class="category-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </section>

            <!-- Playlist Section -->
            <section id="playlistSection" class="playlist-section" style="display: none;">
                <div class="playlist-header">
                    <button id="backToCategories" class="back-btn">â† è¿”å›ç±»åˆ«</button>
                    <h2 id="playlistTitle" class="playlist-title"></h2>
                    <div class="playlist-controls">
                        <button id="shuffleBtn" class="control-btn" title="éšæœºæ’­æ”¾">ğŸ”€</button>
                        <button id="repeatBtn" class="control-btn" title="å¾ªç¯æ’­æ”¾">ğŸ”</button>
                    </div>
                </div>
                <div id="playlistContainer" class="playlist-container">
                    <div id="trackList" class="track-list">
                        <!-- Tracks will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Now Playing Section -->
            <section id="nowPlayingSection" class="now-playing-section">
                <div class="now-playing-content">
                    <div class="track-info">
                        <div class="track-name" id="currentTrackName">æœªæ’­æ”¾</div>
                        <div class="track-artist" id="currentTrackArtist">è¯·é€‰æ‹©éŸ³é¢‘</div>
                        <div class="track-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                        </div>
                    </div>

                    <div class="player-controls">
                        <button id="prevBtn" class="control-btn" title="ä¸Šä¸€æ›²">â®ï¸</button>
                        <button id="playPauseBtn" class="control-btn primary-btn" title="æ’­æ”¾/æš‚åœ">â–¶ï¸</button>
                        <button id="nextBtn" class="control-btn" title="ä¸‹ä¸€æ›²">â­ï¸</button>
                        <button id="stopBtn" class="control-btn" title="åœæ­¢">â¹ï¸</button>
                    </div>

                    <div class="volume-control">
                        <span class="volume-icon">ğŸ”Š</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="70">
                        <span id="volumeValue" class="volume-value">70%</span>
                    </div>
                </div>

                <audio id="audioPlayer" preload="metadata"></audio>
            </section>
        </main>

        <!-- Background Canvas -->
        <canvas id="backgroundCanvas" class="background-canvas"></canvas>

        <!-- Sleep Timer Modal -->
        <div id="sleepTimerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¡çœ å®šæ—¶å™¨</h3>
                    <button class="close-btn" onclick="closeSleepTimer()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="timer-options">
                        <button onclick="setSleepTimer(5)">5åˆ†é’Ÿ</button>
                        <button onclick="setSleepTimer(10)">10åˆ†é’Ÿ</button>
                        <button onclick="setSleepTimer(15)">15åˆ†é’Ÿ</button>
                        <button onclick="setSleepTimer(30)">30åˆ†é’Ÿ</button>
                        <button onclick="setSleepTimer(60)">60åˆ†é’Ÿ</button>
                        <button onclick="setSleepTimer(0)">å…³é—­</button>
                    </div>
                    <div class="custom-timer">
                        <input type="number" id="customTimerMinutes" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿ" min="1" max="480">
                        <button onclick="setCustomSleepTimer()">è®¾ç½®</button>
                    </div>
                    <div id="timerStatus" class="timer-status"></div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel" style="display: none;">
            <div class="debug-header">
                <strong>è°ƒè¯•é¢æ¿</strong>
                <button onclick="toggleDebugPanel()">âœ–</button>
            </div>
            <div id="debugContent"></div>
            <div class="debug-controls">
                <button onclick="runDiagnostics()">è¿è¡Œè¯Šæ–­</button>
                <button onclick="showAppStatus()">åº”ç”¨çŠ¶æ€</button>
                <button onclick="testAudioPlayback()">æµ‹è¯•éŸ³é¢‘</button>
                <button onclick="clearDebugLog()">æ¸…é™¤æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <!-- Security Modules (must load first) -->
    <script src="assets/js/security-utils.js"></script>
    <script src="assets/js/csrf-protection.js"></script>

    <!-- Core Application -->
    <script src="assets/js/audio-config.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- UI Components -->
    <script src="assets/js/ui-controller.js"></script>
    <script src="assets/js/playlist-ui.js"></script>
    <script src="assets/js/audio-manager.js"></script>

    <!-- Background Scenes -->
    <script src="assets/js/background-scene-manager.js"></script>

    <!-- Additional Features -->
    <script src="assets/js/sleep-timer.js"></script>
    <script src="assets/js/theme-manager.js"></script>
    <script src="assets/js/performance-monitor.js"></script>
    <script src="assets/js/visual-effects.js"></script>

    <!-- Security & Accessibility Features -->
    <script src="assets/js/aria-optimizer.js" defer></script>
    <script src="assets/js/sri-manager.js" defer></script>
    <script src="assets/js/gdpr-manager.js" defer></script>

    <script>
        // Global variables
        let app = null;
        let currentCategory = null;
        let isPlaying = false;
        let currentTrackIndex = 0;
        let isShuffleOn = false;
        let isRepeatOn = false;
        let sleepTimerInterval = null;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸµ å£°éŸ³ç–—æ„ˆç©ºé—´å¼€å§‹åˆå§‹åŒ–...');

            try {
                // Hide loading screen after initialization
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    console.log('âœ… åŠ è½½ç•Œé¢å·²æ˜¾ç¤º');
                }, 2000);

                // Initialize app
                if (typeof SoundHealingApp !== 'undefined') {
                    app = new SoundHealingApp();
                    await app.initialize();
                    console.log('âœ… ä¸»åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                }

                // Load categories
                loadCategories();

                // Setup event listeners
                setupEventListeners();

                // Initialize background animation
                initBackgroundAnimation();

                // Show welcome message
                showStatus('ğŸµ å£°éŸ³ç–—æ„ˆç©ºé—´åŠ è½½å®Œæˆï¼é€‰æ‹©ä¸€ä¸ªç±»åˆ«å¼€å§‹ç–—æ„ˆä¹‹æ—…');

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });

        function loadCategories() {
            console.log('ğŸ“‚ å¼€å§‹åŠ è½½éŸ³é¢‘ç±»åˆ«...');
            const categoryGrid = document.getElementById('categoryGrid');

            if (!window.AUDIO_CONFIG) {
                console.error('âŒ AUDIO_CONFIG æœªæ‰¾åˆ°');
                showStatus('âŒ éŸ³é¢‘é…ç½®åŠ è½½å¤±è´¥', 'error');
                return;
            }

            const categories = Object.keys(window.AUDIO_CONFIG.categories);
            console.log(`ğŸ“‚ æ‰¾åˆ° ${categories.length} ä¸ªéŸ³é¢‘ç±»åˆ«`);

            if (categories.length === 0) {
                showStatus('âŒ æ²¡æœ‰æ‰¾åˆ°éŸ³é¢‘ç±»åˆ«', 'error');
                return;
            }

            categoryGrid.innerHTML = '';

            categories.forEach(categoryKey => {
                const category = window.AUDIO_CONFIG.categories[categoryKey];
                const categoryEl = createCategoryElement(categoryKey, category);
                categoryGrid.appendChild(categoryEl);
            });

            console.log(`âœ… æˆåŠŸåŠ è½½ ${categories.length} ä¸ªç±»åˆ«`);
            showStatus(`ğŸµ å·²åŠ è½½ ${categories.length} ä¸ªç–—æ„ˆç±»åˆ«ï¼Œå…± ${countTotalFiles()} ä¸ªéŸ³é¢‘æ–‡ä»¶`);
        }

        function createCategoryElement(categoryKey, category) {
            const div = document.createElement('div');
            div.className = 'category-card';
            div.dataset.category = categoryKey;
            div.onclick = () => openCategory(categoryKey);

            const fileCount = category.files ? category.files.length : 0;

            div.innerHTML = `
                <div class="category-icon">${category.icon || 'ğŸµ'}</div>
                <div class="category-name">${category.name || categoryKey}</div>
                <div class="category-desc">${category.description || 'ç–—æ„ˆéŸ³ä¹'}</div>
                <div class="category-count">${fileCount} ä¸ªéŸ³é¢‘</div>
            `;

            return div;
        }

        function countTotalFiles() {
            if (!window.AUDIO_CONFIG) return 0;

            return Object.values(window.AUDIO_CONFIG.categories)
                .reduce((total, category) => total + (category.files ? category.files.length : 0), 0);
        }

        function openCategory(categoryKey) {
            console.log(`ğŸµ æ‰“å¼€ç±»åˆ«: ${categoryKey}`);
            currentCategory = categoryKey;

            const categorySection = document.getElementById('categorySection');
            const playlistSection = document.getElementById('playlistSection');
            const playlistTitle = document.getElementById('playlistTitle');
            const trackList = document.getElementById('trackList');

            if (!window.AUDIO_CONFIG.categories[categoryKey]) {
                showStatus('âŒ ç±»åˆ«ä¸å­˜åœ¨', 'error');
                return;
            }

            const category = window.AUDIO_CONFIG.categories[categoryKey];
            playlistTitle.textContent = `${category.icon} ${category.name}`;

            // Load tracks
            trackList.innerHTML = '';
            category.files.forEach((fileName, index) => {
                const trackEl = createTrackElement(fileName, index, categoryKey);
                trackList.appendChild(trackEl);
            });

            // Show playlist, hide categories
            categorySection.style.display = 'none';
            playlistSection.style.display = 'block';

            showStatus(`ğŸµ å·²åŠ è½½ ${category.files.length} ä¸ª${category.name}éŸ³é¢‘`);
        }

        function createTrackElement(fileName, index, categoryKey) {
            const div = document.createElement('div');
            div.className = 'track-item';
            div.dataset.trackIndex = index;
            div.dataset.category = categoryKey;
            div.onclick = () => playTrack(index, categoryKey, fileName);

            // Clean up file name for display
            const displayName = fileName.replace('.mp3', '').replace(/\d{1,2}-/, '');

            div.innerHTML = `
                <div class="track-number">${index + 1}</div>
                <div class="track-info">
                    <div class="track-title">${displayName}</div>
                    <div class="track-duration">--:--</div>
                </div>
            `;

            return div;
        }

        function playTrack(index, categoryKey, fileName) {
            console.log(`ğŸµ æ’­æ”¾: ${fileName}`);

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTrackName = document.getElementById('currentTrackName');
            const currentTrackArtist = document.getElementById('currentTrackArtist');

            // Update UI
            currentTrackName.textContent = fileName.replace('.mp3', '');
            currentTrackArtist.textContent = window.AUDIO_CONFIG.categories[categoryKey].name;

            // Get audio URL
            const audioUrl = getAudioUrl(categoryKey, fileName);
            if (!audioUrl) {
                showStatus('âŒ éŸ³é¢‘URLç”Ÿæˆå¤±è´¥', 'error');
                return;
            }

            // Play audio
            audioPlayer.src = audioUrl;
            audioPlayer.play().then(() => {
                isPlaying = true;
                updatePlayPauseButton();
                currentTrackIndex = index;
                showStatus(`ğŸµ æ­£åœ¨æ’­æ”¾: ${fileName.replace('.mp3', '')}`);
            }).catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                showStatus('âŒ æ’­æ”¾å¤±è´¥ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®', 'error');
            });
        }

        function getAudioUrl(categoryKey, fileName) {
            if (!window.AUDIO_CONFIG) return null;

            const category = window.AUDIO_CONFIG.categories[categoryKey];
            if (!category) return null;

            const folderName = category.folder || categoryKey.toLowerCase().replace(/\s+/g, '-');
            return `${window.AUDIO_CONFIG.baseUrl}${folderName}/${encodeURIComponent(fileName)}`;
        }

        function setupEventListeners() {
            // Play/Pause button
            document.getElementById('playPauseBtn').onclick = togglePlayPause;

            // Stop button
            document.getElementById('stopBtn').onclick = stopAudio;

            // Volume control
            const volumeSlider = document.getElementById('volumeSlider');
            volumeSlider.oninput = updateVolume;

            // Progress bar
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.ontimeupdate = updateProgress;
            audioPlayer.onloadedmetadata = updateDuration;
            audioPlayer.onended = handleTrackEnd;

            // Navigation buttons
            document.getElementById('backToCategories').onclick = backToCategories;
            document.getElementById('prevBtn').onclick = playPrevious;
            document.getElementById('nextBtn').onclick = playNext;

            // Control buttons
            document.getElementById('shuffleBtn').onclick = toggleShuffle;
            document.getElementById('repeatBtn').onclick = toggleRepeat;
            document.getElementById('themeToggle').onclick = toggleTheme;
            document.getElementById('sleepTimerBtn').onclick = openSleepTimer;
            document.getElementById('debugToggle').onclick = toggleDebugPanel;

            // Audio player events
            audioPlayer.onplay = () => { isPlaying = true; updatePlayPauseButton(); };
            audioPlayer.onpause = () => { isPlaying = false; updatePlayPauseButton(); };
        }

        function togglePlayPause() {
            const audioPlayer = document.getElementById('audioPlayer');

            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(error => {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    showStatus('âŒ æ’­æ”¾å¤±è´¥', 'error');
                });
            }
        }

        function stopAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            isPlaying = false;
            updatePlayPauseButton();
            showStatus('â¹ï¸ å·²åœæ­¢æ’­æ”¾');
        }

        function updateVolume() {
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            const audioPlayer = document.getElementById('audioPlayer');

            const volume = volumeSlider.value;
            audioPlayer.volume = volume / 100;
            volumeValue.textContent = volume + '%';
        }

        function updateProgress() {
            const audioPlayer = document.getElementById('audioPlayer');
            const progressFill = document.getElementById('progressFill');
            const currentTime = document.getElementById('currentTime');

            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = progress + '%';
                currentTime.textContent = formatTime(audioPlayer.currentTime);
            }
        }

        function updateDuration() {
            const audioPlayer = document.getElementById('audioPlayer');
            const totalTime = document.getElementById('totalTime');

            if (audioPlayer.duration) {
                totalTime.textContent = formatTime(audioPlayer.duration);
            }
        }

        function handleTrackEnd() {
            isPlaying = false;
            updatePlayPauseButton();

            if (isRepeatOn) {
                playCurrentTrack();
            } else {
                playNext();
            }
        }

        function playNext() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            if (isShuffleOn) {
                currentTrackIndex = Math.floor(Math.random() * category.files.length);
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % category.files.length;
            }

            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function playPrevious() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            currentTrackIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : category.files.length - 1;
            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function playCurrentTrack() {
            if (!currentCategory) return;

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (!category || !category.files) return;

            const fileName = category.files[currentTrackIndex];
            playTrack(currentTrackIndex, currentCategory, fileName);
        }

        function toggleShuffle() {
            isShuffleOn = !isShuffleOn;
            const shuffleBtn = document.getElementById('shuffleBtn');
            shuffleBtn.style.opacity = isShuffleOn ? '1' : '0.5';
            showStatus(isShuffleOn ? 'ğŸ”€ éšæœºæ’­æ”¾å·²å¼€å¯' : 'ğŸ”€ éšæœºæ’­æ”¾å·²å…³é—­');
        }

        function toggleRepeat() {
            isRepeatOn = !isRepeatOn;
            const repeatBtn = document.getElementById('repeatBtn');
            repeatBtn.style.opacity = isRepeatOn ? '1' : '0.5';
            showStatus(isRepeatOn ? 'ğŸ” å¾ªç¯æ’­æ”¾å·²å¼€å¯' : 'ğŸ” å¾ªç¯æ’­æ”¾å·²å…³é—­');
        }

        function backToCategories() {
            const categorySection = document.getElementById('categorySection');
            const playlistSection = document.getElementById('playlistSection');

            categorySection.style.display = 'block';
            playlistSection.style.display = 'none';

            showStatus('ğŸ“‚ è¿”å›ç±»åˆ«é€‰æ‹©');
        }

        function updatePlayPauseButton() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showStatus(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);

            // Create status notification
            const status = document.createElement('div');
            status.className = `status-notification ${type}`;
            status.textContent = message;
            status.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#4444ff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(status);

            setTimeout(() => {
                status.remove();
            }, 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            showStatus(isDark ? 'ğŸŒ™ å·²åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜' : 'â˜€ï¸ å·²åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜');
        }

        function openSleepTimer() {
            document.getElementById('sleepTimerModal').style.display = 'block';
        }

        function closeSleepTimer() {
            document.getElementById('sleepTimerModal').style.display = 'none';
        }

        function setSleepTimer(minutes) {
            if (sleepTimerInterval) {
                clearInterval(sleepTimerInterval);
            }

            if (minutes === 0) {
                showStatus('â° ç¡çœ å®šæ—¶å™¨å·²å…³é—­');
                document.getElementById('timerStatus').textContent = '';
                return;
            }

            const endTime = new Date(Date.now() + minutes * 60000);
            document.getElementById('timerStatus').textContent =
                `å®šæ—¶å™¨å·²è®¾ç½®: ${minutes}åˆ†é’Ÿååœæ­¢ (${endTime.toLocaleTimeString()})`;

            sleepTimerInterval = setInterval(() => {
                const now = new Date();
                if (now >= endTime) {
                    stopAudio();
                    clearInterval(sleepTimerInterval);
                    showStatus('â° ç¡çœ å®šæ—¶å™¨æ—¶é—´åˆ°ï¼Œå·²åœæ­¢æ’­æ”¾');
                    document.getElementById('timerStatus').textContent = '';
                }
            }, 1000);

            showStatus(`â° ç¡çœ å®šæ—¶å™¨å·²è®¾ç½®ä¸º${minutes}åˆ†é’Ÿ`);
            closeSleepTimer();
        }

        function setCustomSleepTimer() {
            const minutes = parseInt(document.getElementById('customTimerMinutes').value);
            if (minutes > 0 && minutes <= 480) {
                setSleepTimer(minutes);
            } else {
                showStatus('âŒ è¯·è¾“å…¥1-480ä¹‹é—´çš„åˆ†é’Ÿæ•°', 'error');
            }
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <div><strong>åº”ç”¨çŠ¶æ€:</strong></div>
                <div>â€¢ åº”ç”¨åˆå§‹åŒ–: ${app ? 'âœ…' : 'âŒ'}</div>
                <div>â€¢ å½“å‰ç±»åˆ«: ${currentCategory || 'æ— '}</div>
                <div>â€¢ æ’­æ”¾çŠ¶æ€: ${isPlaying ? 'â–¶ï¸ æ’­æ”¾ä¸­' : 'â¸ï¸ å·²æš‚åœ'}</div>
                <div>â€¢ éšæœºæ’­æ”¾: ${isShuffleOn ? 'âœ…' : 'âŒ'}</div>
                <div>â€¢ å¾ªç¯æ’­æ”¾: ${isRepeatOn ? 'âœ…' : 'âŒ'}</div>
                <div>â€¢ éŸ³é¢‘é…ç½®: ${window.AUDIO_CONFIG ? 'âœ…' : 'âŒ'}</div>
                <div>â€¢ æ€»æ–‡ä»¶æ•°: ${countTotalFiles()}</div>
            `;
        }

        function runDiagnostics() {
            console.log('ğŸ”§ è¿è¡Œè¯Šæ–­...');
            let results = [];

            // æ£€æŸ¥éŸ³é¢‘é…ç½®
            if (window.AUDIO_CONFIG) {
                const categoryCount = Object.keys(window.AUDIO_CONFIG.categories).length;
                const fileCount = countTotalFiles();
                results.push(`âœ… éŸ³é¢‘é…ç½®: ${categoryCount}ä¸ªç±»åˆ«, ${fileCount}ä¸ªæ–‡ä»¶`);
            } else {
                results.push('âŒ éŸ³é¢‘é…ç½®æœªåŠ è½½');
            }

            // æ£€æŸ¥éŸ³é¢‘å…ƒç´ 
            const audioPlayer = document.getElementById('audioPlayer');
            results.push(`ğŸµ éŸ³é¢‘æ’­æ”¾å™¨: ${audioPlayer ? 'âœ…' : 'âŒ'}`);

            // æ£€æŸ¥UIå…ƒç´ 
            const elements = ['categoryGrid', 'trackList', 'playPauseBtn', 'volumeSlider'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                results.push(`ğŸ”² ${id}: ${element ? 'âœ…' : 'âŒ'}`);
            });

            console.log('è¯Šæ–­ç»“æœ:', results);
            showStatus('ğŸ”§ è¯Šæ–­å®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');

            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = '<div><strong>è¯Šæ–­ç»“æœ:</strong></div>' +
                results.map(r => `<div>${r}</div>`).join('');
        }

        function showAppStatus() {
            updateDebugInfo();
            showStatus('ğŸ“Š åº”ç”¨çŠ¶æ€å·²æ›´æ–°åˆ°è°ƒè¯•é¢æ¿');
        }

        function testAudioPlayback() {
            if (!currentCategory) {
                showStatus('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç±»åˆ«', 'error');
                return;
            }

            const category = window.AUDIO_CONFIG.categories[currentCategory];
            if (category && category.files.length > 0) {
                playTrack(0, currentCategory, category.files[0]);
                showStatus('ğŸ§ª æ­£åœ¨æµ‹è¯•ç¬¬ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶');
            }
        }

        function clearDebugLog() {
            document.getElementById('debugContent').innerHTML = '';
            showStatus('ğŸ§¹ è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤');
        }

        function initBackgroundAnimation() {
            const canvas = document.getElementById('backgroundCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Simple particle animation
            const particles = [];
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 3 + 1,
                    opacity: Math.random() * 0.5 + 0.2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                particles.forEach(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;

                    if (particle.x < 0 || particle.x > canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${particle.opacity})`;
                    ctx.fill();
                });

                requestAnimationFrame(animate);
            }

            animate();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const sleepTimerModal = document.getElementById('sleepTimerModal');
            if (event.target === sleepTimerModal) {
                closeSleepTimer();
            }
        }

        // Add slide-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>