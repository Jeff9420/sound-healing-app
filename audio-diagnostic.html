<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘è¯Šæ–­å·¥å…· - SoundFlows</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .status {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        .status-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .success { background: rgba(76, 175, 80, 0.3); }
        .error { background: rgba(244, 67, 54, 0.3); }
        .warning { background: rgba(255, 152, 0, 0.3); }
        .info { background: rgba(33, 150, 243, 0.3); }

        button {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        audio {
            width: 100%;
            margin: 10px 0;
            border-radius: 8px;
        }
        .url-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ éŸ³é¢‘è¯Šæ–­å·¥å…·</h1>

        <div class="card">
            <div class="section-title">
                ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
            </div>
            <div id="system-status">
                <div class="status info">
                    <span class="status-icon">â³</span>
                    <span>æ­£åœ¨æ£€æŸ¥...</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">
                å¿«é€ŸéŸ³é¢‘æµ‹è¯•
            </div>
            <button onclick="testRandomAudio()">ğŸ² éšæœºæµ‹è¯•ä¸€ä¸ªéŸ³é¢‘</button>
            <div id="audio-test-result"></div>
        </div>

        <div class="card">
            <div class="section-title">
                URLç”Ÿæˆæµ‹è¯•
            </div>
            <button onclick="showUrlExamples()">ğŸ”— æŸ¥çœ‹URLç¤ºä¾‹</button>
            <div id="url-examples"></div>
        </div>
    </div>

    <script src="/assets/js/audio-config.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', checkSystem);

        function checkSystem() {
            const statusDiv = document.getElementById('system-status');
            let html = '';

            // æ£€æŸ¥1: AUDIO_CONFIGæ˜¯å¦åŠ è½½
            if (typeof AUDIO_CONFIG !== 'undefined') {
                const categoryCount = Object.keys(AUDIO_CONFIG.categories).length;
                const totalFiles = Object.values(AUDIO_CONFIG.categories)
                    .reduce((sum, cat) => sum + cat.files.length, 0);

                html += `
                    <div class="status success">
                        <span class="status-icon">âœ…</span>
                        <span>é…ç½®å·²åŠ è½½: ${categoryCount} ä¸ªåˆ†ç±»ï¼Œ${totalFiles} ä¸ªæ–‡ä»¶</span>
                    </div>
                `;
            } else {
                html += `
                    <div class="status error">
                        <span class="status-icon">âŒ</span>
                        <span>é…ç½®æœªåŠ è½½ (AUDIO_CONFIG)</span>
                    </div>
                `;
            }

            // æ£€æŸ¥2: getAudioUrlå‡½æ•°æ˜¯å¦å­˜åœ¨
            if (typeof getAudioUrl === 'function') {
                html += `
                    <div class="status success">
                        <span class="status-icon">âœ…</span>
                        <span>URLç”Ÿæˆå‡½æ•°å·²åŠ è½½</span>
                    </div>
                `;
            } else {
                html += `
                    <div class="status error">
                        <span class="status-icon">âŒ</span>
                        <span>URLç”Ÿæˆå‡½æ•°ç¼ºå¤±</span>
                    </div>
                `;
            }

            // æ£€æŸ¥3: Base URL
            if (typeof AUDIO_CONFIG !== 'undefined') {
                const isArchive = AUDIO_CONFIG.baseUrl.includes('archive.org');
                html += `
                    <div class="status ${isArchive ? 'success' : 'warning'}">
                        <span class="status-icon">${isArchive ? 'âœ…' : 'âš ï¸'}</span>
                        <span>Base URL: ${AUDIO_CONFIG.baseUrl.substring(0, 50)}...</span>
                    </div>
                `;
            }

            // æ£€æŸ¥4: æµè§ˆå™¨éŸ³é¢‘æ”¯æŒ
            const audio = document.createElement('audio');
            const mp3Support = audio.canPlayType('audio/mpeg');
            html += `
                <div class="status ${mp3Support ? 'success' : 'error'}">
                    <span class="status-icon">${mp3Support ? 'âœ…' : 'âŒ'}</span>
                    <span>æµè§ˆå™¨MP3æ”¯æŒ: ${mp3Support || 'ä¸æ”¯æŒ'}</span>
                </div>
            `;

            statusDiv.innerHTML = html;
        }

        function testRandomAudio() {
            const resultDiv = document.getElementById('audio-test-result');

            if (typeof AUDIO_CONFIG === 'undefined' || typeof getAudioUrl !== 'function') {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <span class="status-icon">âŒ</span>
                        <span>é…ç½®æœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•</span>
                    </div>
                `;
                return;
            }

            // éšæœºé€‰æ‹©åˆ†ç±»å’Œæ–‡ä»¶
            const categories = Object.keys(AUDIO_CONFIG.categories);
            const randomCategory = categories[Math.floor(Math.random() * categories.length)];
            const category = AUDIO_CONFIG.categories[randomCategory];
            const randomFile = category.files[Math.floor(Math.random() * category.files.length)];

            // ç”ŸæˆURL
            const url = getAudioUrl(randomCategory, randomFile);

            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            const debugInfo = `
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 11px;">
                    <div><strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong></div>
                    <div>Base URL: ${AUDIO_CONFIG.baseUrl}</div>
                    <div>Category Key: ${randomCategory}</div>
                    <div>Folder: ${category.folder || 'æœªè®¾ç½®'}</div>
                    <div>æ–‡ä»¶å(åŸå§‹): ${randomFile}</div>
                    <div>æ–‡ä»¶å(ç¼–ç ): ${encodeURIComponent(randomFile)}</div>
                </div>
            `;

            resultDiv.innerHTML = `
                <div class="status info">
                    <span class="status-icon">ğŸµ</span>
                    <div>
                        <strong>${category.name} (${randomCategory})</strong><br>
                        <small>${randomFile}</small>
                    </div>
                </div>
                ${debugInfo}
                <div class="url-display">${url}</div>
                <button onclick="copyToClipboard('${url.replace(/'/g, "\\'")}')">ğŸ“‹ å¤åˆ¶URL</button>
                <button onclick="window.open('${url.replace(/'/g, "\\'")}', '_blank')">ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</button>
                <audio controls autoplay>
                    <source src="${url}" type="audio/mpeg">
                </audio>
                <div id="play-status" class="status info">
                    <span class="status-icon">â³</span>
                    <span>æ­£åœ¨åŠ è½½...</span>
                </div>
            `;

            // ç›‘å¬éŸ³é¢‘çŠ¶æ€
            const audioElement = resultDiv.querySelector('audio');
            const statusDiv = document.getElementById('play-status');

            audioElement.addEventListener('loadstart', () => {
                statusDiv.innerHTML = `
                    <span class="status-icon">â³</span>
                    <span>æ­£åœ¨ä» Archive.org åŠ è½½...</span>
                `;
                statusDiv.className = 'status info';
            });

            audioElement.addEventListener('canplay', () => {
                statusDiv.innerHTML = `
                    <span class="status-icon">âœ…</span>
                    <span>åŠ è½½æˆåŠŸï¼å¯ä»¥æ’­æ”¾</span>
                `;
                statusDiv.className = 'status success';
            });

            audioElement.addEventListener('playing', () => {
                statusDiv.innerHTML = `
                    <span class="status-icon">â–¶ï¸</span>
                    <span>æ­£åœ¨æ’­æ”¾...</span>
                `;
                statusDiv.className = 'status success';
            });

            audioElement.addEventListener('error', (e) => {
                let errorMsg = 'æœªçŸ¥é”™è¯¯';
                let errorDetails = '';

                if (e.target.error) {
                    errorMsg = `é”™è¯¯ä»£ç : ${e.target.error.code}`;
                    switch(e.target.error.code) {
                        case 1: errorDetails = 'MEDIA_ERR_ABORTED - ç”¨æˆ·ä¸­æ­¢'; break;
                        case 2: errorDetails = 'MEDIA_ERR_NETWORK - ç½‘ç»œé”™è¯¯'; break;
                        case 3: errorDetails = 'MEDIA_ERR_DECODE - è§£ç é”™è¯¯'; break;
                        case 4: errorDetails = 'MEDIA_ERR_SRC_NOT_SUPPORTED - URLæ— æ•ˆæˆ–æ–‡ä»¶ä¸å­˜åœ¨'; break;
                    }
                }

                statusDiv.innerHTML = `
                    <span class="status-icon">âŒ</span>
                    <div>
                        <div>åŠ è½½å¤±è´¥: ${errorMsg}</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">${errorDetails}</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 4px;">
                            å»ºè®®ï¼š1) æ£€æŸ¥Archive.orgé›†åˆæ˜¯å¦å­˜åœ¨ 2) æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦æ­£ç¡®
                        </div>
                    </div>
                `;
                statusDiv.className = 'status error';
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶URL');
            });
        }

        function showUrlExamples() {
            const examplesDiv = document.getElementById('url-examples');

            if (typeof AUDIO_CONFIG === 'undefined' || typeof getAudioUrl !== 'function') {
                examplesDiv.innerHTML = `
                    <div class="status error">
                        <span class="status-icon">âŒ</span>
                        <span>é…ç½®æœªåŠ è½½</span>
                    </div>
                `;
                return;
            }

            let html = '';
            const categories = Object.keys(AUDIO_CONFIG.categories).slice(0, 3); // åªæ˜¾ç¤ºå‰3ä¸ª

            categories.forEach(categoryKey => {
                const category = AUDIO_CONFIG.categories[categoryKey];
                const fileName = category.files[0];
                const url = getAudioUrl(categoryKey, fileName);

                html += `
                    <div class="status success" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span class="status-icon">âœ…</span>
                            <strong>${category.name}</strong>
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">${fileName}</div>
                        <div class="url-display" style="width: 100%;">${url}</div>
                    </div>
                `;
            });

            examplesDiv.innerHTML = html;
        }
    </script>
</body>
</html>
